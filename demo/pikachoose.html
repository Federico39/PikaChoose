<template id="main">
	<div class="pikachoose">
		<pc-stage>

		</pc-stage>
		<pc-thumbnails></pc-thumbnails>
	</div>
	<style>
		:host {
  display: block;
}
* {
  box-sizing: border-box;
  padding: 0;
  margin: 0;
}
.pikachoose {
  overflow: hidden;
}
pc-stage {
  height: auto;
  display: block;
  background: #CCC;
  position: relative;
  transition: transform .3s;
}
pc-stage figure {
  float: left;
  position: relative;
}
pc-stage figcaption {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  color: white;
  background-color: rgba(0, 0, 0, 0.7);
  padding: 5px 10px;
  text-align: center;
  font-family: sans-serif;
}
pc-stage figcaption:empty {
  display: none;
}
a[href]:not([href=""]) {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: block;
}
pc-thumbnails {
  display: inline-block;
  left: 50%;
  transform: translateX(-50%);
  position: relative;
}
pc-thumbnails pc-thumbnail {
  width: 100px;
  display: inline-block;
}
pc-thumbnails pc-thumbnail img {
  width: 100%;
}

	</style>
</template>
<template id="thumbnail">
	<pc-thumbnail>
		<image src="{{source}}">
	</pc-thumbnail>
</template>
<template id="mainImage">
	<figure>
		<image src="{{source}}" title="{{title}}">
		<figcaption>{{caption}}</figcaption>
		<a href="{{link}}" target="{{link_target}}"></a>
	</figure>
</template>
<script>
 	'use strict';
(function (window, document, undefined) {
	var ownerDocument = (document._currentScript || document.currentScript).ownerDocument;

	// Define custom elements used in templates
	ownerDocument.registerElement('pc-stage');
	ownerDocument.registerElement('pc-thumbnails');

	// Gather templates
	var template = ownerDocument.querySelector('template#main').content;
	var thumbnailTemplate = ownerDocument.querySelector('template#thumbnail').content;
	var mainImageTemplate = ownerDocument.querySelector('template#mainImage').content;

	// Create proto
	var pikachoosePrototype = Object.create(HTMLElement.prototype);

	// Cheap template replacement
	pikachoosePrototype.simpleDomReplacement = function (template, replacements) {
		var replacementKeys = Object.keys(replacements);
		[].forEach.call(template.querySelectorAll('*'), function (element) {
			for (var j = 0; j < element.attributes.length; j++) {
				var attributeValue = element.attributes[j].value.substring(2, element.attributes[j].value.length - 2);
				if (replacementKeys.indexOf(attributeValue) !== -1) {
					element.setAttribute(element.attributes[j].name, replacements[attributeValue]);
				}
			}

			var textContent = element.innerHTML.trim();
			textContent = textContent.substring(2, textContent.length - 2);
			if (replacementKeys.indexOf(textContent) !== -1) {
				element.innerHTML = replacements[textContent];
			}
		});
	};

	pikachoosePrototype.initialize = function () {
		// Determine if the user had embedded the elements or will be passing in data
		if (this.originalImages.length) {
			for (var j = 0; j < this.originalImages.length; j++) {
				var image = this.originalImages[j];
				this.addThumbnail({
					source: image.getAttribute('data-thumbnail-src') || image.getAttribute('src')
				});
				this.addGalleryItem({
					source: image.getAttribute('src') || '',
					link: image.getAttribute('data-link') || '',
					caption: image.getAttribute('data-caption') || '',
					title: image.getAttribute('title') || '',
					linkTarget: image.getAttribute('data-link-target') || '_self'
				});
			}
		}
	};

	pikachoosePrototype.addThumbnail = function (source) {
		var cloneNode = thumbnailTemplate.cloneNode(true);
		this.simpleDomReplacement(cloneNode, source);
		this.thumbnailContainer.appendChild(cloneNode);
	};

	pikachoosePrototype.addGalleryItem = function (replacements) {
		var cloneNode = mainImageTemplate.cloneNode(true);
		this.simpleDomReplacement(cloneNode, replacements);
		this.stageContianer.appendChild(cloneNode);
	};

	pikachoosePrototype.forward = function () {
		this.setActiveImage(this.activeImage + 1);
	};

	pikachoosePrototype.backward = function () {
		this.setActiveImage(this.activeImage - 1);
	};

	pikachoosePrototype.setActiveImage = function (position) {
		this.activeImage = position;
		if (this.activeImage < 0) {
			this.activeImage = this.originalImages.length - 1;
		}
		if (this.activeImage > this.originalImages.length - 1) {
			this.activeImage = 0;
		}
		this.updateDisplay();
	};

	pikachoosePrototype.sizeImages = function () {
		var clientWidth = this.clientWidth;
		// Regrabbing images since I plan to add the option
		[].forEach.call(this.stageContianer.querySelectorAll('figure'), function (element) {
			element.style.width = clientWidth + 'px';
		});
	};

	pikachoosePrototype.updateDisplay = function () {
		this.setLeft(this.stageContianer, -(this.activeImage * this.clientWidth));
		this.stageContianer.style.width = this.originalImages.length * this.clientWidth + 'px';
	};

	pikachoosePrototype.attachedCallback = function () {
		this.originalImages = this.querySelectorAll('img');
		this.innerHTML = '';
		this.activeImage = 0;

		this.createShadowRoot();
		this.shadowRoot.appendChild(document.importNode(template, true));
		this.thumbnailContainer = this.shadowRoot.querySelector('pc-thumbnails');
		this.stageContianer = this.shadowRoot.querySelector('pc-stage');

		this.initialize();

		// Hack to allow the correct width to get returned
		setTimeout((function (event) {
			this.updateDisplay();
		}).bind(this), 0);

		this.addEventListener('forward', this.forward.bind(this));
		this.addEventListener('backward', this.backward.bind(this));
		this.shadowRoot.querySelector('pc-stage').addEventListener('click', this.forward.bind(this));

		this.shadowRoot.querySelector('pc-thumbnails').addEventListener('click', (function (e) {
			var element = e.target;
			if (e.target.nodeName === 'IMG') {
				element = e.target.parentNode;
			}
			this.setActiveImage([].indexOf.call(this.shadowRoot.querySelectorAll('pc-thumbnail'), element));
		}).bind(this));
	};

	pikachoosePrototype.setLeft = function (element, left) {
		// TODO: more prefixes!
		element.style.transform = 'translateX(' + left + 'px)';
	};

	window.pikachoose = ownerDocument.registerElement('pikachoose-gallery', {
		prototype: pikachoosePrototype
	});
})(window, document);
</script>
